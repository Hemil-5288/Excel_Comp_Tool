<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Excel Comparison Tool</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { background-color: #f8f9fa; font-family: Arial, sans-serif; }
    .container { max-width: 800px; }
    .card { border-radius: 8px; }
    .btn-primary, .btn-success { font-weight: 500; }
    #status { font-size: 0.95rem; }
    #report { margin-top: 20px; }
    .highlight { background-color: #fff3cd; } /* Highlight differences */
  </style>
</head>
<body>
<div class="container my-5">
  <h2 class="text-center mb-4">Excel Comparison Tool</h2>
  <div class="card shadow-sm p-4">
    <form id="excelForm">
      <div class="mb-3">
        <label class="form-label">Original Excel File</label>
        <input type="file" class="form-control" id="originalFile" required>
      </div>
      <div class="mb-3">
        <label class="form-label">Website Excel File</label>
        <input type="file" class="form-control" id="websiteFile" required>
      </div>
      <button type="submit" id="compareBtn" class="btn btn-primary w-100">Compare Files</button>
    </form>
    <div id="status" class="mt-3"></div>
    <div id="report" class="mt-4"></div>
    <div id="downloadSection" class="mt-3" style="display:none;">
      <button id="downloadBtn" class="btn btn-success w-100">Download Result Excel</button>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
let lastFormData = null;

document.getElementById('excelForm').addEventListener('submit', async (e) => {
  e.preventDefault();
  const originalFile = document.getElementById('originalFile').files[0];
  const websiteFile  = document.getElementById('websiteFile').files[0];

  if (!originalFile || !websiteFile) return alert("Please select both files!");

  const formData = new FormData();
  formData.append('original_file', originalFile);
  formData.append('website_file', websiteFile);
  lastFormData = formData;

  const statusDiv = document.getElementById('status');
  const reportDiv = document.getElementById('report');
  const downloadSection = document.getElementById('downloadSection');
  const compareBtn = document.getElementById('compareBtn');

  const originalCompareText = compareBtn.innerHTML;
  compareBtn.innerHTML = `<span class="spinner-border spinner-border-sm"></span> Comparing...`;
  compareBtn.disabled = true;

  statusDiv.innerHTML = '<div class="alert alert-info">Comparing files...</div>';
  reportDiv.innerHTML = "";
  downloadSection.style.display = "none";

  try {
    // Call API to get only sheet names with differences
    const response = await fetch('http://127.0.0.1:8000/compare/sheets', {
      method: 'POST',
      body: formData
    });
    const data = await response.json();

    if (!data || !data.sheets || data.sheets.length === 0) {
      statusDiv.innerHTML = '<div class="alert alert-warning">No differences found!</div>';
      return;
    }

    // Show clickable sheets
    let html = '<h5>Sheets with differences:</h5><ul class="list-group">';
    data.sheets.forEach(sheet => {
      html += `<li class="list-group-item"><a href="#" class="sheet-link" data-sheet="${sheet}">${sheet}</a></li>`;
    });
    html += '</ul>';
    reportDiv.innerHTML = html;
    statusDiv.innerHTML = '<div class="alert alert-success">Comparison complete!</div>';
    downloadSection.style.display = "block";

    // Add click event to open sheet differences
    document.querySelectorAll(".sheet-link").forEach(link => {
      link.addEventListener("click", async (e) => {
        e.preventDefault();
        const sheet = e.target.dataset.sheet;

        // Open new window immediately
        const newWin = window.open("", "_blank");
        if (!newWin) return alert("Popup blocked! Please allow popups for this site.");
        newWin.document.write(`<p class="text-center">Loading ${sheet} differences...</p>`);

        const sheetForm = new FormData();
        sheetForm.append('original_file', originalFile);
        sheetForm.append('website_file', websiteFile);
        sheetForm.append('sheet_name', sheet);

        try {
          const detailResponse = await fetch('http://127.0.0.1:8000/compare/sheet/diff', {
            method: 'POST',
            body: sheetForm
          });
          const detailData = await detailResponse.json();
          const sheetRows = detailData.different_rows || [];

          let detailHtml = `<html><head><title>${sheet} Differences</title>`;
          detailHtml += `<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">`;
          detailHtml += `<style>.highlight{background-color:#fff3cd;}</style></head><body>`;
          detailHtml += `<div class="container my-4"><h3>${sheet} - All Different Rows</h3>`;

          if(sheetRows.length > 0){
            detailHtml += `<table class="table table-bordered table-striped"><thead><tr>`;
            detailHtml += sheetRows[0].map(h=>`<th>${h}</th>`).join("");
            detailHtml += `</tr></thead><tbody>`;
            for(let i=1;i<sheetRows.length;i++){
              detailHtml += `<tr>`;
              for(let j=0;j<sheetRows[i].length;j++){
                detailHtml += `<td class="highlight">${sheetRows[i][j]}</td>`;
              }
              detailHtml += `</tr>`;
            }
            detailHtml += `</tbody></table>`;
          } else {
            detailHtml += `<div class="alert alert-info">No differences found in this sheet.</div>`;
          }
          detailHtml += `</div></body></html>`;

          newWin.document.open();
          newWin.document.write(detailHtml);
          newWin.document.close();

        } catch(err) {
          newWin.document.write(`<div class="alert alert-danger">Error loading sheet: ${err}</div>`);
        }
      });
    });

  } catch (err) {
    statusDiv.innerHTML = `<div class="alert alert-danger">Error: ${err}</div>`;
  } finally {
    compareBtn.innerHTML = originalCompareText;
    compareBtn.disabled = false;
  }
});

// Download Excel
document.getElementById('downloadBtn').addEventListener('click', async () => {
  if (!lastFormData) return alert("Please run a comparison first.");
  const downloadBtn = document.getElementById('downloadBtn');
  const originalText = downloadBtn.innerHTML;
  downloadBtn.innerHTML = `<span class="spinner-border spinner-border-sm"></span> Preparing file...`;
  downloadBtn.disabled = true;

  try {
    const response = await fetch('http://127.0.0.1:8000/compare', {
      method: 'POST',
      body: lastFormData
    });
    const blob = await response.blob();
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `comparison_result_${Date.now()}.xlsx`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    window.URL.revokeObjectURL(url);
  } catch (err) {
    alert("Download error: " + err);
  } finally {
    downloadBtn.innerHTML = originalText;
    downloadBtn.disabled = false;
  }
});
</script>
</body>
</html>
